<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Report Action -->
        <record id="action_report_pawn_renewal_receipt" model="ir.actions.report">
            <field name="name">Renewal Receipt</field>
            <field name="model">pawn.ticket</field>
            <field name="report_type">qweb-pdf</field>
            <field name="report_name">pawnshop.report_pawn_renewal_receipt_document</field>
            <field name="report_file">pawnshop.report_pawn_renewal_receipt_document</field>
            <field name="binding_model_id" ref="model_pawn_ticket"/>
            <field name="binding_type">report</field>
            <field name="print_report_name">'Renewal Receipt - %s' % object.ticket_no</field>
        </record>

        <!-- Report Template -->
        <template id="report_pawn_renewal_receipt_document">
            <t t-call="web.html_container">
                <t t-foreach="docs" t-as="o">
                    <t t-call="web.external_layout">
                        <div class="page" style="font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 9pt; line-height: 1.3;">
                            <!-- Header -->
                            <div class="row" style="margin-bottom: 10px;">
                                <div class="col-8">
                                    <h2 style="font-size: 14pt; font-weight: 600; margin-bottom: 5px;"><strong>RENEWAL RECEIPT</strong></h2>
                                    <h4 style="font-size: 11pt; margin-bottom: 4px;">Ticket No: <span t-field="o.ticket_no" class="text-primary"/></h4>
                                </div>
                                <div class="col-4 text-end">
                                    <img t-att-src="'/report/barcode/QR/%s?width=90&amp;height=90' % o.ticket_no"
                                         style="width:90px;height:90px;"/>
                                </div>
                            </div>

                            <!-- Branch and Date -->
                            <div class="row" style="margin-bottom: 8px;">
                                <div class="col-6">
                                    <p style="margin-bottom: 2px; font-size: 8.5pt;"><strong>Branch:</strong> <span t-field="o.branch_id.name"/></p>
                                    <p style="margin-bottom: 2px; font-size: 8.5pt;"><span t-field="o.branch_id.street"/></p>
                                    <p style="margin-bottom: 0; font-size: 8.5pt;" t-if="o.branch_id.phone"><i class="fa fa-phone" style="font-size: 7pt;"/> <span t-field="o.branch_id.phone"/></p>
                                </div>
                                <div class="col-6 text-end">
                                    <p style="margin-bottom: 2px; font-size: 8.5pt;"><strong>Renewal Date:</strong> <span t-field="o.date_renewed" t-options="{'widget': 'date'}"/></p>
                                    <p style="margin-bottom: 0; font-size: 8.5pt;" class="text-danger"><strong>New Maturity Date:</strong> <span t-field="o.date_maturity" t-options="{'widget': 'date'}"/></p>
                                </div>
                            </div>

                            <hr style="margin: 6px 0; border-top: 1px solid #dee2e6;"/>

                            <!-- Customer Info -->
                            <div class="row" style="margin-bottom: 8px;">
                                <div class="col-12">
                                    <p style="margin-bottom: 2px; font-size: 8.5pt;"><strong>Customer:</strong> <span t-field="o.customer_id.name"/></p>
                                    <p style="margin-bottom: 0; font-size: 8.5pt;"><strong>Phone:</strong> <span t-field="o.customer_id.phone"/></p>
                                </div>
                            </div>

                            <hr style="margin: 6px 0; border-top: 1px solid #dee2e6;"/>

                            <!-- Renewal Charges -->
                            <div class="row" style="margin-bottom: 8px;">
                                <div class="col-12">
                                    <h5 class="text-primary" style="font-size: 10pt; font-weight: 600; margin-bottom: 4px;">Renewal Charges</h5>
                                    <table class="table table-bordered" style="font-size: 8pt;">
                                        <thead style="background-color: #f8f9fa;">
                                            <tr>
                                                <th style="padding: 3px 6px; font-size: 8.5pt;">Description</th>
                                                <th class="text-end" style="padding: 3px 6px; font-size: 8.5pt;">Amount</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td style="padding: 2px 6px;"><strong>Principal Amount</strong> (not due at renewal)</td>
                                                <td class="text-end text-muted" style="padding: 2px 6px;">
                                                    <span t-field="o.principal_amount" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 2px 6px;">Interest Charges</td>
                                                <td class="text-end" style="padding: 2px 6px;">
                                                    <span t-field="o.interest_amount" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                                </td>
                                            </tr>
                                            <tr t-if="o.penalty_amount > 0">
                                                <td style="padding: 2px 6px;">Penalty Charges</td>
                                                <td class="text-end" style="padding: 2px 6px;">
                                                    <span t-field="o.penalty_amount" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 2px 6px;">Service Fee</td>
                                                <td class="text-end" style="padding: 2px 6px;">
                                                    <span t-field="o.service_fee" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                                </td>
                                            </tr>
                                        </tbody>
                                        <tfoot>
                                            <tr class="table-success">
                                                <th style="padding: 4px 6px; font-size: 9pt;"><strong>Total Renewal Payment</strong></th>
                                                <th class="text-end" style="padding: 4px 6px;">
                                                    <strong style="font-size: 10pt;">
                                                        <t t-set="renewal_total" t-value="o.interest_amount + o.penalty_amount + o.service_fee"/>
                                                        <span t-esc="renewal_total" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                                    </strong>
                                                </th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>

                            <!-- Payment Info -->
                            <div class="row" style="margin-bottom: 8px;" t-if="o.invoice_ids">
                                <div class="col-12">
                                    <h6 class="text-primary" style="font-size: 9.5pt; font-weight: 600; margin-bottom: 3px;">Payment Information</h6>
                                    <t t-set="latest_invoice" t-value="o.invoice_ids.filtered(lambda inv: inv.move_type == 'out_invoice').sorted('date', reverse=True)[:1]"/>
                                    <div t-if="latest_invoice" style="font-size: 8.5pt;">
                                        <p style="margin-bottom: 2px;"><strong>Invoice No:</strong> <span t-field="latest_invoice.name"/></p>
                                        <p style="margin-bottom: 2px;"><strong>Invoice Date:</strong> <span t-field="latest_invoice.invoice_date" t-options="{'widget': 'date'}"/></p>
                                        <p style="margin-bottom: 0;"><strong>Payment Status:</strong>
                                        <span t-if="latest_invoice.payment_state == 'paid'" class="badge bg-success" style="font-size: 7pt; padding: 2px 5px;">Paid</span>
                                        <span t-elif="latest_invoice.payment_state == 'partial'" class="badge bg-warning" style="font-size: 7pt; padding: 2px 5px;">Partially Paid</span>
                                        <span t-else="" class="badge bg-danger" style="font-size: 7pt; padding: 2px 5px;">Not Paid</span></p>
                                    </div>
                                </div>
                            </div>

                            <hr style="margin: 6px 0; border-top: 1px solid #dee2e6;"/>

                            <!-- Summary Box -->
                            <div class="row" style="margin-bottom: 8px;">
                                <div class="col-12">
                                    <div class="alert alert-info" style="padding: 8px 10px; font-size: 8pt; margin-bottom: 0;">
                                        <h6 style="font-size: 9pt; font-weight: 600; margin-bottom: 3px;"><strong>Renewed Loan Summary</strong></h6>
                                        <div class="row">
                                            <div class="col-6">
                                                <strong>Principal Balance:</strong>
                                                <span t-field="o.principal_amount" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                            </div>
                                            <div class="col-6">
                                                <strong>New Maturity Date:</strong>
                                                <span t-field="o.date_maturity" t-options="{'widget': 'date'}" class="text-danger"/>
                                            </div>
                                        </div>
                                        <div class="row" style="margin-top: 4px;">
                                            <div class="col-12">
                                                <strong>Next Payment Due:</strong>
                                                <t t-set="next_due" t-value="o.principal_amount + o.interest_amount"/>
                                                <span t-esc="next_due" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                                on <span t-field="o.date_maturity" t-options="{'widget': 'date'}"/>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Important Notes -->
                            <div class="row" style="margin-bottom: 8px;">
                                <div class="col-12">
                                    <div class="alert alert-warning" style="padding: 6px 10px; font-size: 7.5pt; margin-bottom: 0;">
                                        <strong style="font-size: 8pt;"><i class="fa fa-exclamation-triangle" style="font-size: 7pt;"/> Important:</strong>
                                        <ul style="margin-bottom: 0; padding-left: 16px; margin-top: 3px;">
                                            <li style="margin-bottom: 2px;">Keep this receipt for your records</li>
                                            <li style="margin-bottom: 2px;">Items remain in custody and can be redeemed at any time</li>
                                            <li style="margin-bottom: 2px;">Renew or redeem before the new maturity date to avoid penalties</li>
                                            <li style="margin-bottom: 0;">Grace period: <t t-esc="request.env['ir.config_parameter'].sudo().get_param('pawnshop.grace_period_days', '7')"/> days after maturity</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Signature -->
                            <div class="row" style="margin-top: 20px;">
                                <div class="col-6 text-center">
                                    <div style="border-top: 1px solid #000; display: inline-block; padding: 3px 40px;">
                                        <span style="font-size: 8pt;">Customer Signature</span>
                                    </div>
                                </div>
                                <div class="col-6 text-center">
                                    <div style="border-top: 1px solid #000; display: inline-block; padding: 3px 40px;">
                                        <span style="font-size: 8pt;">Cashier</span>
                                    </div>
                                    <br/>
                                    <small style="font-size: 7.5pt;"><span t-field="o.write_uid.name"/></small>
                                </div>
                            </div>

                            <!-- Footer -->
                            <div class="row" style="margin-top: 10px;">
                                <div class="col-12 text-center text-muted">
                                    <small style="font-size: 7pt;">Thank you for your business! | <span t-field="o.branch_id.phone"/></small>
                                </div>
                            </div>

                        </div>
                    </t>
                </t>
            </t>
        </template>

    </data>
</odoo>
