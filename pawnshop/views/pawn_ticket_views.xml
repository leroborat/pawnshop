<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Pawn Ticket List View -->
        <record id="view_pawn_ticket_list" model="ir.ui.view">
            <field name="name">pawn.ticket.list</field>
            <field name="model">pawn.ticket</field>
            <field name="arch" type="xml">
                <list string="Pawn Tickets" default_order="date_created desc" decoration-danger="is_overdue and not is_in_grace" decoration-warning="is_in_grace" decoration-info="is_due_today" decoration-muted="state in ('cancelled', 'redeemed', 'forfeited')">
                    <field name="ticket_no"/>
                    <field name="customer_id"/>
                    <field name="branch_id"/>
                    <field name="date_created"/>
                    <field name="date_maturity"/>
                    <field name="days_to_maturity" string="Days"/>
                    <field name="principal_amount" widget="monetary"/>
                    <field name="total_due" widget="monetary"/>
                    <field name="state" widget="badge" decoration-success="state == 'pledged'" decoration-info="state == 'renewed'" decoration-warning="state == 'draft'" decoration-danger="state == 'forfeited'" decoration-muted="state in ('cancelled', 'redeemed')"/>
                    <field name="is_overdue" column_invisible="1"/>
                    <field name="is_in_grace" column_invisible="1"/>
                    <field name="is_due_today" column_invisible="1"/>
                </list>
            </field>
        </record>

        <!-- Pawn Ticket Form View -->
        <record id="view_pawn_ticket_form" model="ir.ui.view">
            <field name="name">pawn.ticket.form</field>
            <field name="model">pawn.ticket</field>
            <field name="arch" type="xml">
                <form string="Pawn Ticket">
                    <header>
                        <button name="action_disburse" string="Disburse" type="object"
                                invisible="state != 'draft'"
                                class="oe_highlight"
                                groups="pawnshop.group_pawn_cashier"/>
                        <button name="action_renew" string="Renew" type="object"
                                invisible="state not in ('pledged', 'renewed')"
                                class="btn-primary"
                                groups="pawnshop.group_pawn_cashier"/>
                        <button name="action_redeem" string="Redeem" type="object"
                                invisible="state not in ('pledged', 'renewed')"
                                class="btn-success"
                                groups="pawnshop.group_pawn_cashier"/>
                        <button name="action_forfeit" string="Forfeit" type="object"
                                invisible="state not in ('pledged', 'renewed')"
                                confirm="Are you sure you want to forfeit this ticket? This action cannot be undone."
                                groups="pawnshop.group_pawn_manager"/>
                        <button name="action_cancel" string="Cancel" type="object"
                                invisible="state != 'draft'"
                                groups="pawnshop.group_pawn_manager"/>
                        <field name="state" widget="statusbar" statusbar_visible="draft,pledged,renewed,redeemed"/>
                    </header>
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button name="action_view_invoices" type="object"
                                    class="oe_stat_button" icon="fa-file-text-o"
                                    invisible="invoice_count == 0">
                                <field name="invoice_count" widget="statinfo" string="Invoices"/>
                            </button>
                        </div>
                        <widget name="web_ribbon" title="Cancelled" bg_color="text-bg-danger" invisible="state != 'cancelled'"/>
                        <widget name="web_ribbon" title="Redeemed" bg_color="text-bg-success" invisible="state != 'redeemed'"/>
                        <widget name="web_ribbon" title="Forfeited" bg_color="text-bg-warning" invisible="state != 'forfeited'"/>
                        <div class="oe_title">
                            <h1>
                                <field name="ticket_no" readonly="1"/>
                            </h1>
                        </div>
                        <group>
                            <group name="customer_info" string="Customer Information">
                                <field name="customer_id" options="{'no_create': True, 'no_open': True}"/>
                                <field name="branch_id" options="{'no_create': True}" readonly="state != 'draft'"/>
                                <field name="date_created" readonly="1"/>
                                <field name="date_pledged" readonly="1"/>
                            </group>
                            <group name="financial_info" string="Financial Information">
                                <field name="principal_amount" readonly="state != 'draft'" widget="monetary"/>
                                <field name="appraised_value" readonly="1" widget="monetary"/>
                                <field name="ltv_ratio" widget="percentage"/>
                                <field name="interest_rate" readonly="state != 'draft'" widget="percentage"/>
                                <field name="rate_table_id" options="{'no_create': True}"/>
                            </group>
                        </group>
                        <group>
                            <group name="dates" string="Important Dates">
                                <field name="date_maturity" readonly="state not in ('draft', 'pledged', 'renewed')"/>
                                <field name="date_grace_end" readonly="1"/>
                                <field name="days_to_maturity" invisible="state in ('draft', 'cancelled')"/>
                                <field name="date_renewed" readonly="1" invisible="not date_renewed"/>
                                <field name="date_redeemed" readonly="1" invisible="not date_redeemed"/>
                                <field name="date_forfeited" readonly="1" invisible="not date_forfeited"/>
                            </group>
                            <group name="amounts" string="Amounts Due">
                                <field name="interest_amount" widget="monetary" readonly="1"/>
                                <field name="penalty_amount" widget="monetary" readonly="1"/>
                                <field name="service_fee" widget="monetary" readonly="1"/>
                                <field name="total_due" widget="monetary" readonly="1" class="oe_subtotal_footer_separator"/>
                                <field name="currency_id" invisible="1"/>
                            </group>
                        </group>
                        <notebook>
                            <page string="Pawned Items" name="items">
                                <field name="line_ids" readonly="state not in ('draft', 'pledged')">
                                    <list editable="bottom">
                                        <field name="sequence" widget="handle"/>
                                        <field name="name"/>
                                        <field name="category_id" options="{'no_create': True}"/>
                                        <field name="brand"/>
                                        <field name="model"/>
                                        <field name="serial_number"/>
                                        <field name="condition"/>
                                        <field name="appraised_value" widget="monetary" sum="Total Appraised"/>
                                        <field name="currency_id" column_invisible="1"/>
                                    </list>
                                </field>
                            </page>
                            <page string="KYC / Identity" name="kyc">
                                <group>
                                    <group string="ID Information">
                                        <field name="kyc_id_type"/>
                                        <field name="kyc_id_number"/>
                                        <field name="kyc_id_expiry"/>
                                    </group>
                                    <group string="Photos">
                                        <field name="kyc_photo" widget="image" options="{'size': [150, 150]}"/>
                                        <field name="kyc_id_photo_front" widget="image" options="{'size': [150, 150]}"/>
                                        <field name="kyc_id_photo_back" widget="image" options="{'size': [150, 150]}"/>
                                    </group>
                                </group>
                            </page>
                            <page string="Disbursement" name="disbursement" invisible="state == 'draft'">
                                <group>
                                    <group>
                                        <field name="disbursement_method"/>
                                        <field name="disbursement_reference"/>
                                    </group>
                                    <group>
                                        <field name="disbursement_date" readonly="1"/>
                                        <field name="disbursed_by" readonly="1"/>
                                    </group>
                                </group>
                            </page>
                            <page string="Terms &amp; Notes" name="notes">
                                <group>
                                    <field name="terms_accepted" readonly="state != 'draft'"/>
                                    <field name="notes" placeholder="Internal notes (not visible to customer)..." nolabel="1"/>
                                </group>
                            </page>
                        </notebook>
                    </sheet>
                    <chatter/>
                </form>
            </field>
        </record>

        <!-- Pawn Ticket Kanban View -->
        <record id="view_pawn_ticket_kanban" model="ir.ui.view">
            <field name="name">pawn.ticket.kanban</field>
            <field name="model">pawn.ticket</field>
            <field name="arch" type="xml">
                <kanban default_group_by="state" class="o_kanban_small_column" quick_create="false">
                    <field name="ticket_no"/>
                    <field name="customer_id"/>
                    <field name="branch_id"/>
                    <field name="date_maturity"/>
                    <field name="days_to_maturity"/>
                    <field name="principal_amount"/>
                    <field name="total_due"/>
                    <field name="state"/>
                    <field name="status_color"/>
                    <field name="is_overdue"/>
                    <field name="is_in_grace"/>
                    <field name="is_due_today"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div t-attf-class="oe_kanban_color_#{kanban_getcolor(record.status_color.raw_value)} oe_kanban_card oe_kanban_global_click">
                                <div class="oe_kanban_content">
                                    <div class="o_kanban_record_top">
                                        <div class="o_kanban_record_headings">
                                            <strong class="o_kanban_record_title">
                                                <field name="ticket_no"/>
                                            </strong>
                                        </div>
                                        <span t-if="record.is_overdue.raw_value and not record.is_in_grace.raw_value" class="badge badge-danger">Overdue</span>
                                        <span t-if="record.is_in_grace.raw_value" class="badge badge-warning">Grace</span>
                                        <span t-if="record.is_due_today.raw_value" class="badge badge-info">Due Today</span>
                                    </div>
                                    <div class="o_kanban_record_body">
                                        <field name="customer_id"/>
                                        <br/>
                                        <small>
                                            Branch: <field name="branch_id"/>
                                        </small>
                                        <br/>
                                        <small>
                                            Maturity: <field name="date_maturity"/>
                                            (<field name="days_to_maturity"/> days)
                                        </small>
                                    </div>
                                    <div class="o_kanban_record_bottom">
                                        <div class="oe_kanban_bottom_left">
                                            <strong>Principal: <field name="principal_amount" widget="monetary"/></strong>
                                        </div>
                                        <div class="oe_kanban_bottom_right">
                                            <strong>Due: <field name="total_due" widget="monetary"/></strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- Pawn Ticket Search View -->
        <record id="view_pawn_ticket_search" model="ir.ui.view">
            <field name="name">pawn.ticket.search</field>
            <field name="model">pawn.ticket</field>
            <field name="arch" type="xml">
                <search string="Search Pawn Tickets">
                    <field name="ticket_no"/>
                    <field name="customer_id"/>
                    <field name="branch_id"/>
                    <field name="date_created"/>
                    <field name="date_maturity"/>

                    <filter string="Draft" name="filter_draft" domain="[('state', '=', 'draft')]"/>
                    <filter string="Pledged" name="filter_pledged" domain="[('state', '=', 'pledged')]"/>
                    <filter string="Renewed" name="filter_renewed" domain="[('state', '=', 'renewed')]"/>
                    <filter string="Redeemed" name="filter_redeemed" domain="[('state', '=', 'redeemed')]"/>
                    <filter string="Forfeited" name="filter_forfeited" domain="[('state', '=', 'forfeited')]"/>
                    <separator/>
                    <filter string="Active" name="filter_active" domain="[('state', 'in', ('pledged', 'renewed'))]"/>
                    <filter string="Due Today" name="filter_due_today" domain="[('is_due_today', '=', True)]"/>
                    <filter string="Overdue" name="filter_overdue" domain="[('is_overdue', '=', True)]"/>
                    <filter string="In Grace Period" name="filter_in_grace" domain="[('is_in_grace', '=', True)]"/>
                    <separator/>
                    <filter string="Created Today" name="filter_created_today"
                            domain="[('date_created', '&gt;=', context_today().strftime('%Y-%m-%d 00:00:00')),
                                     ('date_created', '&lt;=', context_today().strftime('%Y-%m-%d 23:59:59'))]"/>
                    <filter string="Created This Week" name="filter_created_week"
                            domain="[('date_created', '&gt;=', (context_today() - relativedelta(weeks=1)).strftime('%Y-%m-%d'))]"/>
                    <filter string="Created This Month" name="filter_created_month"
                            domain="[('date_created', '&gt;=', context_today().strftime('%Y-%m-01'))]"/>

                    <group>
                        <filter string="Branch" name="group_branch" context="{'group_by':'branch_id'}"/>
                        <filter string="Status" name="group_state" context="{'group_by':'state'}"/>
                        <filter string="Customer" name="group_customer" context="{'group_by':'customer_id'}"/>
                        <filter string="Date Created" name="group_date_created" context="{'group_by':'date_created'}"/>
                        <filter string="Maturity Date" name="group_maturity" context="{'group_by':'date_maturity'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- Pawn Ticket Action -->
        <record id="action_pawn_ticket" model="ir.actions.act_window">
            <field name="name">Pawn Tickets</field>
            <field name="res_model">pawn.ticket</field>
            <field name="view_mode">list,kanban,form</field>
            <field name="context">{'search_default_filter_active': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Create your first pawn ticket
                </p>
                <p>
                    Pawn tickets track items pledged as collateral for loans.
                    Each ticket includes customer information, item details, and payment terms.
                </p>
            </field>
        </record>

        <!-- Ticket Line Form View (for opening from ticket) -->
        <record id="view_pawn_ticket_line_form" model="ir.ui.view">
            <field name="name">pawn.ticket.line.form</field>
            <field name="model">pawn.ticket.line</field>
            <field name="arch" type="xml">
                <form string="Pawned Item">
                    <sheet>
                        <group>
                            <group string="Item Information">
                                <field name="name"/>
                                <field name="category_id" options="{'no_create': True}"/>
                                <field name="brand"/>
                                <field name="model"/>
                                <field name="serial_number"/>
                                <field name="color"/>
                                <field name="condition"/>
                            </group>
                            <group string="Valuation">
                                <field name="appraised_value" widget="monetary"/>
                                <field name="appraised_by"/>
                                <field name="appraisal_date"/>
                                <field name="currency_id" invisible="1"/>
                            </group>
                        </group>
                        <group string="Specifications (Optional)">
                            <group>
                                <field name="weight"/>
                                <field name="weight_unit"/>
                                <field name="karat"/>
                            </group>
                            <group>
                                <field name="barcode"/>
                                <field name="product_id" options="{'no_create': True}"/>
                            </group>
                        </group>
                        <notebook>
                            <page string="Photos" name="photos">
                                <group>
                                    <group>
                                        <field name="photo_1" widget="image" options="{'size': [200, 200]}"/>
                                        <field name="photo_2" widget="image" options="{'size': [200, 200]}"/>
                                    </group>
                                    <group>
                                        <field name="photo_3" widget="image" options="{'size': [200, 200]}"/>
                                        <field name="photo_4" widget="image" options="{'size': [200, 200]}"/>
                                    </group>
                                </group>
                            </page>
                            <page string="Appraisal Notes" name="notes">
                                <field name="appraisal_notes" placeholder="Detailed appraisal notes..." nolabel="1"/>
                            </page>
                        </notebook>
                    </sheet>
                </form>
            </field>
        </record>

    </data>
</odoo>
